name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Java & Android SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk wget unzip tar

      - name: Download Godot Editor
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip
          unzip Godot_v4.4.1-stable_linux.x86_64.zip
          mv Godot_v4.4.1-stable_linux.x86_64 godot
          chmod +x godot

      - name: Prepare Godot Templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.4.1.stable
          wget https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
          unzip Godot_v4.4.1-stable_export_templates.tpz -d ~/.local/share/godot/export_templates/4.4.1.stable

      - name: Create Android Export Preset
        run: |
          mkdir -p android/build
          cat <<EOT > export_presets.cfg
          [preset.0]
          name="Android"
          platform="Android"
          runnable=true
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="android/build/Lifelink.apk"
          script_export_mode=1
          script_encryption_key=""
          
          [preset.0.options]
          gradle_build/use_gradle_build=true
          gradle_build/min_sdk=21
          gradle_build/target_sdk=34
          gradle_build/build_tool="default"
          keystore/release=""
          keystore/release_user=""
          keystore/release_password=""
          EOT

      - name: Build Android APK
        run: |
          ./godot --headless --verbose --export-release "Android" android/build/Lifelink.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Lifelink-Android-APK
          path: android/build/Lifelink.apk
